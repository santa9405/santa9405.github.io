---
title: "WebServer"
excerpt: "WebServer Project - 게시글 수정"
search: true
categories: 
  - Academy
tags: 
  - Servlet
  - Java
  - HTML
  - CSS
  - JSP
toc: true
---
## 기능 화면
- 게시글 수정<br>
<br><br>![녹화_2021_01_10_17_49_13_453](https://user-images.githubusercontent.com/72387870/104118413-396dc280-536c-11eb-86c0-fa67c3ce20e1.gif)

## 실습

### com.kh.wsp/board/controller

- BoardController.java

```java
package com.kh.wsp.board.controller;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.kh.wsp.board.model.service.BoardService;
import com.kh.wsp.board.model.vo.Attachment;
import com.kh.wsp.board.model.vo.Board;
import com.kh.wsp.board.model.vo.PageInfo;
import com.kh.wsp.common.MyFileRenamePolicy;
import com.kh.wsp.member.model.vo.Member;
import com.oreilly.servlet.MultipartRequest;

@WebServlet("/board/*")
public class BoardControlloer extends HttpServlet {
	private static final long serialVersionUID = 1L;

	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		String uri = request.getRequestURI();          // /wsp/board/list.do 요청이 들어오는 주소
		String contextPath = request.getContextPath(); // /wsp 프로젝트 주소
		String command = uri.substring( (contextPath + "/board").length() ); // /wsp/board를 잘라낸 주소 == /list.do
		
		//System.out.println(command);
		
		String path = null;
		RequestDispatcher view = null;
		
		String swalIcon = null;
		String swalTitle = null;
		String swalText = null;
		
		String errorMsg = null;
		
		try {
			BoardService service = new BoardService();
			
			// 현재 페이지를 얻어옴
			String cp = request.getParameter("cp"); // 현재 null인 상태
			
			// currentPage 사용 이유
			// 1. 페이징 처리 시 계산에 필요한 값이기 때문
			// 2. 상세조회, 북마크 등의 UI/UX 향상을 위해 사용
			
			// 게시글 목록 조회 Controller------------------------------------
			if(command.equals("/list.do")) {
				errorMsg = "게시판 목록 조회 과정에서 오류 발생";
				
				// 1. 페이징 처리를 위한 값 계산 Service 호출
				PageInfo pInfo = service.getPageInfo(cp);
				//System.out.println(pInfo);
				
				// 2. 게시글 목록 조회 비즈니스 로직 수행
				List<Board> bList = service.selectBoardList(pInfo);
				// pInfo에 있는 currentPage, limit를 사용해야지만
				// 현재 페이지에 맞는 게시글 목록만 조회할 수 있음.
				
//				for(Board b : bList) {
//					System.out.println(b);
//				}
				
				// 3. 게시글 목록이 조회 되었을 때 해당 게시글 목록 요소에 작성된 썸네일 이미지 목록 얻어오기
				if(bList != null) {
					// 썸네일 이미지 목록 조회 서비스 호출
					List<Attachment> fList = service.selectThumbnailList(pInfo);
					
					// 썸네일 이미지 목록이 비어있지 않은 경우
					if(!fList.isEmpty()) {
						request.setAttribute("fList", fList);
					}
				}
				
				path = "/WEB-INF/views/board/boardList.jsp";
				
				request.setAttribute("bList", bList);
				request.setAttribute("pInfo", pInfo);
				
				view = request.getRequestDispatcher(path);
				view.forward(request, response);
			}
			
			
			// 게시글 상세 조회 Controller-------------------------------------------------
			else if(command.equals("/view.do")) {
				errorMsg = "게시글 상세 조회 과정에서 오류 발생";
				int boardNo = Integer.parseInt(request.getParameter("no"));
				
				// 상세조회 비즈니스 로직 수행 후 결과 반환 받기
				Board board = service.selectBoard(boardNo);
				
				if(board != null) { // 상세 조회 성공
					
					// 해당 게시글에 포함된 이미지 파일 목록 조회 서비스 호출
					List<Attachment> fList = service.selectBoardFiles(boardNo);
					
					if(!fList.isEmpty()) { // 해당 게시글 이미지 정보가 DB에 있을 경우
						request.setAttribute("fList", fList);
					}
					
					path = "/WEB-INF/views/board/boardView.jsp";
					request.setAttribute("board", board);
					view = request.getRequestDispatcher(path);
					view.forward(request, response);
					
				}else { // 상세 조회 실패
					
					request.getSession().setAttribute("swalIcon", "error");
					request.getSession().setAttribute("swalTitle", "게시글 상세 조회 실패");
					response.sendRedirect("list.do?cp=1");
				}
			}
			
			// 게시글 작성 화면 전환 Controller----------------------------------------------
			else if(command.equals("/insertForm.do")) {
				
				path = "/WEB-INF/views/board/boardInsert.jsp";
				view = request.getRequestDispatcher(path);
				view.forward(request, response);
			}
			
			// 게시글 등록 Controller (+ 파일 업로드)----------------------------------------
			else if(command.equals("/insert.do")) {
				
				errorMsg = "게시글 등록 과정에서 오류 발생";
				
				// 제출(요청)되는 form 태그의 encType이 multipart/form-data 형식이면
				// 기존에 사용하던 request 객체로 파라미터를 얻어올 수 없다.
				// --> cos.jar에서 제공하는 MultipartRequest 객체를 사용하면
				//     파라미터를 얻어올 수 있다.
				
				// 1. MultipartRequest 객체 생성하기
				// 1-1. 전송 파일 용량 지정(byte 단위)
				int maxSize = 20 * 1024 * 1024; // 20MB == 20 * 1024KB == 20 * 1024 * 1024Byte
				
				// 1-2. 서버에 업로드된 파일을 저장할 경로 지정
				String root = request.getSession().getServletContext().getRealPath("/"); // 실제주소 WebContent가 반환됨
				String filePath = root + "resources/uploadImages/";
				
				//System.out.println("filePath : " + filePath);
				
				// 1-3. 파일명 변환을 위한 클래스 작성하기
				// cos.jar에서 중복되는 파일이 업로드 되었을 때
				// 파일명을 바꿔주는 DefaultFileRenamePolicy 클래스를 제공해 주지만
				// ex) a.jpg, a(1).jpg, a(2).jpg
				// 파일명에 업로드된 시간을 표기할 수 있도록 변경하는 별도의 클래스를 작성할 예정.
				
				// 1-4. MultipartRequest 객체 생성
				// -> 객체 생성과 동시에 파라미터로 넘어온 내용 중 파일이 서버에 바로 저장됨.
				MultipartRequest multiRequest 
					= new MultipartRequest(request, filePath, maxSize, "UTF-8", new MyFileRenamePolicy());
															// 파일을 제외한건 UTF-8로 인코딩 하겠다
				
				// 2. 생성한 MultipartRequest 객체에서 파일 정보만을 얻어와
				//    별도의 List에 모두 저장하기
				
				// 2-1. 파일 정보를 모두 저장할 List 객체 생성
				List<Attachment> fList = new ArrayList<Attachment>();
				
				// 2-2. MultipartRequest에서 업로드된 파일의 name 속성값 반환 받기
				Enumeration<String> files = multiRequest.getFileNames();
				//System.out.println(files);
				// Iterator : 컬렉션 요소 반복 접근자
				// Enumeration : Iterator의 과거 버전
				
				// 2-3. 얻어온 Enumeration 객체에 요소를 하나씩 반복 접근하여
				//		업로드된 파일 정보를 Attachment 객체에 저장한 후
				//		fList에 추가하기
				while(files.hasMoreElements()) { // 다음 요소가 있다면
					
					// 현재 접근한  요소 값 반환
					String name = files.nextElement(); // img0
//					System.out.println("name : " + name);
//					System.out.println("원본 파일명 : " 
//										+ multiRequest.getOriginalFileName(name));
//					System.out.println("변경된 파일명 : " + multiRequest.getFilesystemName(name));
					
					// 제출받은 file태그 요소 중 업로드 된 파일이 있을 경우
					if( multiRequest.getFilesystemName(name) != null) {
						
						// Attachment 객체에 파일 정보 저장
						Attachment temp = new Attachment();
						
						temp.setFileName(multiRequest.getFilesystemName(name));
						temp.setFilePath(filePath);
						
						// name 속성에 따라 fileLevel 지정
						int fileLevel = 0;
						switch(name) {
						case "img0" : fileLevel = 0; break;
						case "img1" : fileLevel = 1; break;
						case "img2" : fileLevel = 2; break;
						case "img3" : fileLevel = 3; break;
						}
						
						temp.setFileLevel(fileLevel);
						
						// fList에 추가
						fList.add(temp);
					}
				} // end wile
				
				// 3. 파일정보를 제외한 게시글 정보를 얻어와 저장하기
				String boardTitle = multiRequest.getParameter("boardTitle");
				String boardContent = multiRequest.getParameter("boardContent");
				int categoryCode = Integer.parseInt(multiRequest.getParameter("categoryCode"));
				
				// 세션에서 로그인한 회원의 번호를 얻어오기
				Member loginMember = (Member)request.getSession().getAttribute("loginMember");
				int boardWriter = loginMember.getMemberNo();
				
				// fList, boardTitle, boardContent, categoryCode, boardWriter
				
				// Map 객체를 생성하여 얻어온 정보들을 모두 저장
				Map<String, Object> map = new HashMap<String, Object>();
				map.put("fList", fList);
				map.put("boardTitle", boardTitle);
				map.put("boardContent", boardContent);
				map.put("categoryCode", categoryCode);
				map.put("boardWriter", boardWriter);
				
				// 4. 게시글 등록 비즈니스 로직 수행 후 결과 반환 받기
				int result = service.insertBoard(map);
				
				if(result > 0) { // DB 삽입 성공 시 result에는 삽입한 글 번호가 저장되어있다!
					swalIcon = "success";
					swalTitle = "게시글 등록 성공";
					path = "view.do?cp=1&no=" + result;
				}else {
					swalIcon = "error";
					swalTitle = "게시글 등록 실패";
					path = "list.do"; // 게시글 목록
				}
				
				request.getSession().setAttribute("swalIcon", swalIcon);
				request.getSession().setAttribute("swalTitle", swalTitle);
				response.sendRedirect(path);
			}
			
			// 게시글 수정 화면 전환 Controller------------------------------------
			else if(command.equals("/updateForm.do")) {
				
				errorMsg = "게시글 수정 화면 전환 과정에서 오류 발생";
				
				// 수정 화면이 미리 이전 내용이 작성돼있을 수 있도록
				// 글 번호를 이용하여 이전 내용을 조회해옴
				
				int boardNo = Integer.parseInt(request.getParameter("no"));
				
				Board board = service.updateView(boardNo);
				
				// 업데이트 화면 출력용 게시글 조회가 성공한 경우
				if(board != null) {
					// 해당 게시글에 작성된 이미지(파일) 목록 정보 조회
					List<Attachment> fList = service.selectBoardFiles(boardNo);
					
					if(!fList.isEmpty()) {
						request.setAttribute("fList", fList);
					}
					
					request.setAttribute("board", board);
					path = "/WEB-INF/views/board/boardUpdate.jsp";
					view = request.getRequestDispatcher(path);
					view.forward(request, response);
					
				}else {
					request.getSession().setAttribute("swalIcon", "error");
					request.getSession().setAttribute("swalTitle", "게시글 수정 화면 전환 실패");
					response.sendRedirect(request.getHeader("referer"));
					// 상세 조회 -> 수정 화면 -> 상세 조회
				}
			}
			
	         // 게시글 수정 Controller ********************************
            else if(command.equals("/update.do")) {
               
               errorMsg = "게시글 수정 과정에서 오류 발생";
               
               // 1. MultipartRequest 객체 생성에 필요한 값 설정
               int maxSize = 20 * 1024 * 1024; // 최대 크기 20MB
               String root = request.getServletContext().getRealPath("/");
               String filePath = root + "resources/uploadImages/";
               
               // 2. MultipartRequest 객체 생성
               // -> 생성과 동시에 전달받은 파일이 서버에 저장됨
               MultipartRequest mRequest = new MultipartRequest(request, filePath, maxSize, "UTF-8", new MyFileRenamePolicy());
               
               // 3. 파일 정보를 제외한 파라미터 얻어오기
               String boardTitle = mRequest.getParameter("boardTitle");
               String boardContent = mRequest.getParameter("boardContent");
               int categoryCode = Integer.parseInt(mRequest.getParameter("categoryCode"));
               int boardNo = Integer.parseInt(mRequest.getParameter("no"));
               
               // 4. 전달받은 파일 정보를 List에 저장
               List<Attachment> fList = new ArrayList<Attachment>();
               Enumeration<String> files = mRequest.getFileNames();
               // input type="file"인 모든 요소의 name 속성 값을 반환받아 files에 저장
               
               while(files.hasMoreElements()) {
                  // 현재 접근중인 name속성값을 변수에 저장
                  String name = files.nextElement();
                 
                  // 현재 name 속성이 일치하는 요소로 업로드된 파일이 있다면
                  if(mRequest.getFilesystemName(name) != null) {
                     
                     Attachment temp = new Attachment();
                     
                     // 변경된 파일 이름 temp에 저장
                     temp.setFileName(mRequest.getFilesystemName(name));
                     
                     // 지정한 파일 경로 tmep에 저장
                     temp.setFilePath(filePath);
                     
                     // 해당 게시글 번호 temp에 저장
                     temp.setParentBoardNo(boardNo);
                     
                     // 파일 레벨 temp에 저장
                     switch(name) {
                     case "img0" : temp.setFileLevel(0); break;
                     case "img1" : temp.setFileLevel(1); break;
                     case "img2" : temp.setFileLevel(2); break;
                     case "img3" : temp.setFileLevel(3); break;
                     }
                     
                     // temp를 fList에 추가
                     fList.add(temp);
                    // 이미지를 변경한 부분들만 fList에 추가가 된다.
                  }
               }
               
               // 5. Session에서 로그인한 회원의 번호를 얻어와 저장
               int boardWriter = ((Member)request.getSession().getAttribute("loginMember")).getMemberNo();
               
               // 6. 준비된 값들을 하나의 Map에 저장
               Map<String, Object> map = new HashMap<String, Object>();
               map.put("boardTitle", boardTitle);
               map.put("boardContent", boardContent);
               map.put("categoryCode",categoryCode);
               map.put("boardNo",boardNo);
               map.put("fList",fList);
               map.put("boardWriter",boardWriter);
               
               // 7. 준비된 값을 매개변수로 하여 게시글 수정 Service 호출
               int result = service.updateBoard(map);
               
               // 8. result 값에 따라 View 연결 처리
               path = "view.do?cp=" + cp + "&no=" + boardNo;
               String sk = mRequest.getParameter("sk");
               String sv = mRequest.getParameter("sv");
               
               // 전달된 sk,sv가 존재 할 때 (검색을 통한 접근일 때)
               if(sk != null && sv != null ) {
                  path += "&sk="+sk + "&sv=" + sv;
               }
               
               

               if (result>0) {
                  swalIcon = "success";
                  swalTitle = "게시글 수정 성공";
                  
                  
                                 
               }else {
                  swalIcon = "error";
                  swalTitle = "게시글 수정 실패";
               }
               request.getSession().setAttribute("swalIcon", swalIcon);
               request.getSession().setAttribute("swalTitle", swalTitle);
               
               response.sendRedirect(path);
            }
	         
	      } catch (Exception e) {
	         e.printStackTrace();
	         path = "/WEB-INF/views/common/errorPage.jsp";
	         request.setAttribute("errorMsg", errorMsg);
	         view = request.getRequestDispatcher(path);
	         view.forward(request, response);
	      }
	   }

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		doGet(request, response);
	}
}
```
<br><br>

### com.kh.wsp/board/service

- BoardService.java

```java
package com.kh.wsp.board.model.service;

import static com.kh.wsp.common.JDBCTemplate.*;

import java.io.File;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import com.kh.wsp.board.model.dao.BoardDAO;
import com.kh.wsp.board.model.exception.FileInsertFailedException;
import com.kh.wsp.board.model.vo.Attachment;
import com.kh.wsp.board.model.vo.Board;
import com.kh.wsp.board.model.vo.PageInfo;

public class BoardService {

	private BoardDAO dao = new BoardDAO();

	/**
	 * 페이징 처리를 위한 값 계산 Service
	 * 
	 * @param cp
	 * @return pInfo
	 * @throws Exception
	 */
	public PageInfo getPageInfo(String cp) throws Exception {
		Connection conn = getConnection();

		// cp가 null일 경우
		int currentPage = cp == null ? 1 : Integer.parseInt(cp);

		// DB에서 전체 게시글 수를 조회하여 반환 받기
		int listCount = dao.getListCount(conn);

		close(conn);

		// 얻어온 현재 페이지와, DB에서 조회한 전체 게시글 수를 이용하여
		// PageInfo 객체를 생성함
		return new PageInfo(currentPage, listCount);
	}

	/**
	 * 게시글 목록 조회 Service
	 * 
	 * @param pInfo
	 * @return bList
	 * @throws Exception
	 */
	public List<Board> selectBoardList(PageInfo pInfo) throws Exception {
		Connection conn = getConnection();

		List<Board> bList = dao.selectBoardList(conn, pInfo);

		close(conn);

		return bList;
	}

	/**
	 * 게시글 상세 조회 Service
	 * 
	 * @param boardNo
	 * @return board
	 * @throws Exception
	 */
	public Board selectBoard(int boardNo) throws Exception {
		Connection conn = getConnection();
		Board board = dao.selectBoard(conn, boardNo);

		if (board != null) { // DB에서 조회 성공 시

			// 조회수 증가
			int result = dao.increaseReadCount(conn, boardNo);

			if (result > 0) {
				commit(conn);

				// 반환되는 Board 데이터에는 조회수가 증가되어 있지 않기 때문에
				// 조회수를 1 증가 시켜줌
				board.setReadCount(board.getReadCount() + 1);

			} else {
				rollback(conn);
			}

		}
		close(conn);
		return board;
	}

	/**
	 * 게시글 등록 Service (게시글 + 파일)
	 * 
	 * @param map
	 * @return result
	 * @throws Exception
	 */
	public int insertBoard(Map<String, Object> map) throws Exception {

		Connection conn = getConnection();

		int result = 0;

		// 1. 게시글 번호 얻어오기
		int boardNo = dao.selectNextNo(conn);

		if (boardNo > 0) {
			// 얻어온 게시글 번호를 map에 추가(게시글, 파일정보 삽입 DAO에서 사용하기 위해)
			map.put("boardNo", boardNo);

			// 2. 글 제목/내용 크로스 사이트 스크립팅 방지 처리
			String boardTitle = (String) map.get("boardTitle");
			String boardContent = (String) map.get("boardContent");

			boardTitle = replaceParameter(boardTitle);
			boardContent = replaceParameter(boardContent);

			// 3. 글 내용 개행문자 \r\n -> <br> 변경 처리
			boardContent = boardContent.replaceAll("\r\n", "<br>");

			// 처리된 내용을 다시 map에 추가
			map.put("boardTitle", boardTitle);
			map.put("boardContent", boardContent);

			try {
				// 4. 게시글 부분(제목, 내용, 카테고리)만 BOARD 테이블에 삽입하는 DAO 호출
				result = dao.insertBoard(conn, map);

				// 5. 파일 정보 부분만 ATTACHMENT 테이블에 삽입하는 DAO 호출
				List<Attachment> fList = (List<Attachment>) map.get("fList");

				// 게시글 부분 삽입 성공 && 파일 정보가 있을 경우
				if (result > 0 && !fList.isEmpty()) {

					result = 0; // result 재활용을 위해 0으로 초기화

					// fList의 요소를 하나씩 반복 접근하여
					// DAO 메소드를 반복 호출해 정보를 삽입
					for (Attachment at : fList) {

						// 파일 정보가 저장된 Attachment 객체에
						// 해당 파일이 작성된 게시글 번호를 추가 세팅
						at.setParentBoardNo(boardNo);

						result = dao.insertAttachment(conn, at);

						if (result == 0) { // 파일 정보 삽입 실패
							// break; // 보류

							// 강제로 예외 발생
							throw new FileInsertFailedException("파일 정보 삽입 실패");
						}
					}
				}

			} catch (Exception e) {
				// 4,5번에 대한 추가 작업
				// 게시글 또는 파일 정보 삽입 중 에러 발생 시
				// 서버에 저장된 파일을 삭제하는 작업이 필요함.

				List<Attachment> fList = (List<Attachment>) map.get("fList");

				if (!fList.isEmpty()) {

					for (Attachment at : fList) {

						String filePath = at.getFilePath();
						String fileName = at.getFileName();

						File deleteFile = new File(filePath + fileName);

						if (deleteFile.exists()) {
							// 해당 경로에 해당 파일이 존재하면
							deleteFile.delete(); // 해당 파일 삭제
						}
					}
				}

				// 에러페이지가 보여질 수 있도록 catch한 Exception을 Controller로 던져줌
				throw e;

			} // end catch

			// 6. 트랜잭션 처리
			if (result > 0) {
				commit(conn);

				// 삽입 성공 시 상세 조회 화면으로 이동해야 하기 때문에
				// 글 번호를 반환할 수 있도록 result에 boardNo를 대입
				result = boardNo;

			} else {
				rollback(conn);
			}

		}

		// 7. 커넥션 반환
		close(conn);

		// 8. 결과 반환
		return result;
	}

	// 크로스 사이트 스크립팅 방지 메소드
	private String replaceParameter(String param) {
		String result = param;
		if (param != null) {
			result = result.replaceAll("&", "&amp;");
			result = result.replaceAll("<", "&lt;");
			result = result.replaceAll(">", "&gt;");
			result = result.replaceAll("\"", "&quot;");
		}

		return result;
	}

	/**
	 * 게시글에 포함된 이미지 목록 조회 Service
	 * 
	 * @param boardNo
	 * @return fList
	 * @throws Exception
	 */
	public List<Attachment> selectBoardFiles(int boardNo) throws Exception {
		Connection conn = getConnection();

		List<Attachment> fList = dao.selectBoardFiles(conn, boardNo);

		close(conn);

		return fList;
	}

	/**
	 * 썸네일 목록 조회 Service
	 * 
	 * @param pInfo
	 * @return fList
	 * @throws Exception
	 */
	public List<Attachment> selectThumbnailList(PageInfo pInfo) throws Exception {
		Connection conn = getConnection();

		List<Attachment> fList = dao.selectThumbnailList(conn, pInfo);

		close(conn);

		return fList;
	}

	/**
	 * 게시글 수정 화면 출력용 Service
	 * 
	 * @param boardNo
	 * @return board
	 * @throws Exception
	 */
	public Board updateView(int boardNo) throws Exception {

		Connection conn = getConnection();

		// 이전에 만들어 놓은 상세조회 DAO 호출
		Board board = dao.selectBoard(conn, boardNo);

		// textarea 출력을 위한 개행문자 변경
		board.setBoardContent(board.getBoardContent().replaceAll("<br>", "\r\n"));

		close(conn);

		return board;
	}

	 /** 게시글 수정 Service
     * @param map
     * @return
     * @throws Exception
     */
    public int updateBoard(Map<String, Object> map) throws Exception {
       Connection conn = getConnection();

       int result = 0; // Service 수정 결과 저장 변수

       List<Attachment> deleteFiles = null; // 삭제할 파일 정보 저장 변수 선언

       // 1. 크로스 사이트 스크립팅 방지 처리

       String boardTitle = (String) map.get("boardTitle");
       String boardContent = (String) map.get("boardContent");

       boardTitle = replaceParameter(boardTitle);
       boardContent = replaceParameter(boardContent);

       // 2. 글 내용 개행문자 \r\n -> <br>
       boardContent.replaceAll("\r\n", "<br>");

       // 처리된 내용을 다시 map에 추가
       map.put("boardTitle", boardTitle);
       map.put("boardContent", boardContent);
       
       try {
          // 3. 게시글 부분 수정 DAO 호출
          result = dao.updateBoard(conn, map);
          
          // 4. 게시글 수정이 성공하고 fList가 비어있지 않으면
          //      파일 정보 수정 DAO를 호출함
          
          // 수정 화면에서 새로운 이미지가 업로드된 파일 정보만을 담고 있는 List
          List<Attachment> newFileList = (List<Attachment>)map.get("fList");
          
          
          if(result > 0 && !newFileList.isEmpty()) {
             
             // DB에서 해당 게시글의 수정전 파일 목록 조회
             List<Attachment> oldFileList = dao.selectBoardFiles(conn, (int)map.get("boardNo"));
             
             // newFileList -> 수정된 썸네일(lv.0)
             
             // oldFileList -> 썸네일(lv.0), 이미지 (lv.1), 이미지2(lv.2)
             
             // 기존 썸네일(lv.0) -> 수정된 썸네일(lv.0)로 변경됨
             // -> DB에서 기존 썸네일의 데이터를 수정된 썸네일로 변경
             //   --> DB에서 기존 썸네일 정보가 사라짐
             
             result = 0; // result 재활용
             deleteFiles = new ArrayList<Attachment>(); // 삭제될 파일 정보 저장 List
             
             // 새로운 이미지 정보 반복 접근
             for(Attachment newFile : newFileList) {
                
                // flag가 false인 경우 : 새 이미지와 기존 이미지의 파일 레벨이 중복되는 경우 -> update
                // flag가 true인 경우 : 새 이미지와 기존 이미지의 파일 레벨이 중복되지 않는 경우 -> insert
                boolean flag = true;
                
                // 기존 이미지 정보 반복 접근
                for(Attachment oldFile : oldFileList) {
                   
                   // 새로운 이미지와 기존 이미지의 파일 레벨이 동일한 파일이 있다면
                   if(newFile.getFileLevel() == oldFile.getFileLevel()) {
                      
                      // 기존 파일을 삭제 List에 추가
                      deleteFiles.add(oldFile);
                      
                      // 새 이미지 정보에 이전 파일 번호를 추가 -> 파일 번호를 이용한 수정 진행
                      newFile.setFileNo(oldFile.getFileNo());
                      
                      flag = false;
                      
                      break;
                   }
                }
                
                // flag 값에 따라 파일 정보 insert 또는 update수행
                if(flag) {
                   result = dao.insertAttachment(conn, newFile);
                }else {
                   result = dao.updateAttachment(conn, newFile);
                }
                
                // 파일 정보 삽입 또는 수정 중 실패 시
                if(result == 0) {
                   // 강제로 사용자 정의 예외 발생
                   throw new FileInsertFailedException("파일 정보 삽입 또는 수정 실패");
                }
             }
          }
          
          
       } catch (Exception e) {
          // 게시글 수정 중 실패 또는 오류 발생 시
          // 서버에 미리 저장되어 있던 이미지 파일 삭제
          List<Attachment> fList = (List<Attachment>)map.get("fList");
          
          if(!fList.isEmpty()) {
             for(Attachment at : fList) {
                String filePath = at.getFilePath();
                String fileName = at.getFileName();
                
                File deleteFile = new File(filePath + fileName);
                
                if(deleteFile.exists()) {
                   // 해당 경로에 해당 파일이 존재하면
                   deleteFile.delete(); // 해당 파일 삭제
                }
             }
          }
          
          // 에러페이지가 보여질 수 있도록 catch한 Exception을 Controller로 던져줌
          throw e; 
       }
       
       // 5. 트랜잭션 처리 및 삭제 목록에 있는 파일 삭제
       if(result > 0) {
          commit(conn);
          
          // DB 정보와 맞지 않는 파일(deleteFiles) 삭제 진행
          if(deleteFiles != null) {
             
             for(Attachment at : deleteFiles) {
                String filePath = at.getFilePath();
                String fileName = at.getFileName();
                
                File deleteFile = new File(filePath + fileName);
                
                if(deleteFile.exists()) {
                   deleteFile.delete();
                }
             }
          }
       }else {
          rollback(conn);
       }
       return result;
    }
}
```
<br><br>

### com.kh.wsp/board/vo

- Board.java

```java
package com.kh.wsp.board.model.vo;

import java.sql.Timestamp;

public class Board {
	// V_BOARD의 모양
	private int boardNo;
	private String boardTitle;
	private String boardContent;
	private String memberId;
	private int readCount;
	private String categoryName;
	private Timestamp boardCreateDate;
	private Timestamp boardModifyDate;
	private String boardStatus;
	
	public Board() { }

	public Board(int boardNo, String boardTitle, String boardContent, String memberId, int readCount,
			String categoryName, Timestamp boardCreateDate, Timestamp boardModifyDate, String boardStatus) {
		super();
		this.boardNo = boardNo;
		this.boardTitle = boardTitle;
		this.boardContent = boardContent;
		this.memberId = memberId;
		this.readCount = readCount;
		this.categoryName = categoryName;
		this.boardCreateDate = boardCreateDate;
		this.boardModifyDate = boardModifyDate;
		this.boardStatus = boardStatus;
	}
	
	// 게시글 목록 조회
	public Board(int boardNo, String boardTitle, String memberId, int readCount, String categoryName,
			Timestamp boardCreateDate) {
		super();
		this.boardNo = boardNo;
		this.boardTitle = boardTitle;
		this.memberId = memberId;
		this.readCount = readCount;
		this.categoryName = categoryName;
		this.boardCreateDate = boardCreateDate;
	}

	public int getBoardNo() {
		return boardNo;
	}

	public void setBoardNo(int boardNo) {
		this.boardNo = boardNo;
	}

	public String getBoardTitle() {
		return boardTitle;
	}

	public void setBoardTitle(String boardTitle) {
		this.boardTitle = boardTitle;
	}

	public String getBoardContent() {
		return boardContent;
	}

	public void setBoardContent(String boardContent) {
		this.boardContent = boardContent;
	}

	public String getMemberId() {
		return memberId;
	}

	public void setMemberId(String memberId) {
		this.memberId = memberId;
	}

	public int getReadCount() {
		return readCount;
	}

	public void setReadCount(int readCount) {
		this.readCount = readCount;
	}

	public String getCategoryName() {
		return categoryName;
	}

	public void setCategoryName(String categoryName) {
		this.categoryName = categoryName;
	}

	public Timestamp getBoardCreateDate() {
		return boardCreateDate;
	}

	public void setBoardCreateDate(Timestamp boardCreateDate) {
		this.boardCreateDate = boardCreateDate;
	}

	public Timestamp getBoardModifyDate() {
		return boardModifyDate;
	}

	public void setBoardModifyDate(Timestamp boardModifyDate) {
		this.boardModifyDate = boardModifyDate;
	}

	public String getBoardStatus() {
		return boardStatus;
	}

	public void setBoardStatus(String boardStatus) {
		this.boardStatus = boardStatus;
	}

	@Override
	public String toString() {
		return "Board [boardNo=" + boardNo + ", boardTitle=" + boardTitle + ", boardContent=" + boardContent
				+ ", memberId=" + memberId + ", readCount=" + readCount + ", categoryName=" + categoryName
				+ ", boardCreateDate=" + boardCreateDate + ", boardModifyDate=" + boardModifyDate + ", boardStatus="
				+ boardStatus + "]";
	}
}
```
<br><br>

- PageInfo.java

```java
package com.kh.wsp.board.model.vo;

public class PageInfo { // 페이징 처리를 위한 값을 저장할 객체
	
	// 얻어올 값
	private int currentPage;   // 현재 페이지 번호를 저장할 변수
	private int listCount;	   // 전체 게시글 수를 저장할 변수
	
	// 설정할 값
	private int limit = 10;    // 한 페이지에 보여질 게시글 목록 수
	private int pageSize = 10; // 하단의 페이징바에 표시될 페이지 수
	
	// 계산할 값
	private int maxPage;       // 페이징바 전체 페이지의 수 == 마지막 페이지
    private int startPage;     // 페이징바 시작 페이지 번호
    private int endPage;       // 페이징바 끝 페이지 번호
    
    // 기본 생성자 사용X
    
	public PageInfo(int currentPage, int listCount) {
		super();
		this.currentPage = currentPage;
		this.listCount = listCount;
		
		// vo가 생성 되자마자
		// 전달받은 값과 명시적으로 선언된 값을 이용하여
		// makePageInfo() 수행
		makePageInfo();
	}

	public PageInfo(int currentPage, int listCount, int limit, int pageSize) {
		super();
		this.currentPage = currentPage;
		this.listCount = listCount;
		this.limit = limit;
		this.pageSize = pageSize;
		
		makePageInfo();
	}

	public int getCurrentPage() {
		return currentPage;
	}

	public void setCurrentPage(int currentPage) {
		this.currentPage = currentPage;
	}

	public int getListCount() {
		return listCount;
	}

	public void setListCount(int listCount) {
		this.listCount = listCount;
		makePageInfo();
	}

	public int getLimit() {
		return limit;
	}

	public void setLimit(int limit) {
		this.limit = limit;
		makePageInfo();
	}

	public int getPageSize() {
		return pageSize;
	}

	public void setPageSize(int pageSize) {
		this.pageSize = pageSize;
		makePageInfo();
	}

	public int getMaxPage() {
		return maxPage;
	}

	public void setMaxPage(int maxPage) {
		this.maxPage = maxPage;
	}

	public int getStartPage() {
		return startPage;
	}

	public void setStartPage(int startPage) {
		this.startPage = startPage;
	}

	public int getEndPage() {
		return endPage;
	}

	public void setEndPage(int endPage) {
		this.endPage = endPage;
	}

	@Override
	public String toString() {
		return "PageInfo [currentPage=" + currentPage + ", listCount=" + listCount + ", limit=" + limit + ", pageSize="
				+ pageSize + ", maxPage=" + maxPage + ", startPage=" + startPage + ", endPage=" + endPage + "]";
	}
	
	// 페이징 처리에 필요한 값을 계산하는 메소드
	private void makePageInfo() {
		
		// maxPage : 페이징바 전체 페이지의 수 == 마지막 페이지
		// 총 게시글 수 100개, 한 페이지에 보여지는 게시글 수 10개
		// -> 총 페이지 수는? 100 / 10 = 10page
		
		// 총 게시글 수 100개, 한 페이지에 보여지는 게시글 수 10개
		// -> 총 페이지 수는? 101 / 10 = 10.1(올림 처리) -> 11page
		maxPage = (int)Math.ceil( (double)listCount / limit );
		
		// startPage : 페이징바 시작 번호
		// 페이징바에 페이지를 10개씩 보여줄 경우
		// 1, 11, 21, 31, ...
		// 현재 페이지 11 -> 시작 페이지 11
		// 현재 페이지 15 -> 시작 페이지 11
		// 현재 페이지 20 -> 시작 페이지 11
		startPage = (currentPage -1) / pageSize * pageSize + 1;
					//        (11-1) /  10 * 10 + 1 == 11
					//        (15-1) /  10 * 10 + 1 == 11
					//        (20-1) /  10 * 10 + 1 == 11
		
		// endPage : 페이징바 끝 번호
		// 페이징바에 페이지를 10개씩 보여줄 경우
		// 10, 20, 30, 40, ...
		// 현재 페이지 11 -> 시작 페이지 20
		// 현재 페이지 15 -> 시작 페이지 20
		// 현재 페이지 20 -> 시작 페이지 20
		endPage = startPage + pageSize - 1;
		
		// 총 페이지의 수가 endPage 보다 작을 경우
		if(maxPage <= endPage) {
			endPage = maxPage;
		}
	}
}
```
<br><br>

- Attachment.java

```java
package com.kh.wsp.board.model.vo;

public class Attachment {

	private int fileNo;
	private String filePath;
	private String fileName;
	private int fileLevel;
	private int parentBoardNo;
	
	public Attachment() {}
	
	public Attachment(int fileNo, String fileName, int fileLevel) {
		super();
		this.fileNo = fileNo;
		this.fileName = fileName;
		this.fileLevel = fileLevel;
	}

	public Attachment(int fileNo, String filePath, String fileName, int fileLevel, int parantBoardNo) {
		super();
		this.fileNo = fileNo;
		this.filePath = filePath;
		this.fileName = fileName;
		this.fileLevel = fileLevel;
		this.parentBoardNo = parantBoardNo;
	}
	public int getFileNo() {
		return fileNo;
	}
	public void setFileNo(int fileNo) {
		this.fileNo = fileNo;
	}
	public String getFilePath() {
		return filePath;
	}
	public void setFilePath(String filePath) {
		this.filePath = filePath;
	}
	public String getFileName() {
		return fileName;
	}
	public void setFileName(String fileName) {
		this.fileName = fileName;
	}
	public int getFileLevel() {
		return fileLevel;
	}
	public void setFileLevel(int fileLevel) {
		this.fileLevel = fileLevel;
	}
	public int getParentBoardNo() {
		return parentBoardNo;
	}
	public void setParentBoardNo(int parantBoardNo) {
		this.parentBoardNo = parantBoardNo;
	}
	@Override
	public String toString() {
		return "Attachment [fileNo=" + fileNo + ", filePath=" + filePath + ", fileName=" + fileName + ", fileLevel="
				+ fileLevel + ", parantBoardNo=" + parentBoardNo + "]";
	}
}
```
<br><br>

### com.kh.wsp/board/dao

- BoardDAO.java

```java
package com.kh.wsp.board.model.dao;

import static com.kh.wsp.common.JDBCTemplate.*;

import java.io.FileInputStream;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import com.kh.wsp.board.model.vo.Attachment;
import com.kh.wsp.board.model.vo.Board;
import com.kh.wsp.board.model.vo.PageInfo;

public class BoardDAO {
	private Statement stmt = null;
	private PreparedStatement pstmt = null;
	private ResultSet rset = null;
	
	private Properties prop = null;
	
	public BoardDAO(){
		String fileName = BoardDAO.class.getResource("/com/kh/wsp/sql/board/board-query.xml").getPath();
		try {
			prop = new Properties();
			prop.loadFromXML(new FileInputStream(fileName)); 
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/** 전체 게시글 수 반환 DAO
	 * @param conn
	 * @return listCount
	 * @throws Exception
	 */
	public int getListCount(Connection conn) throws Exception {
		int listCount = 0;
		
		String query = prop.getProperty("getListCount");
		
		try {
			stmt = conn.createStatement();
			
			rset = stmt.executeQuery(query);
			
			if(rset.next()) {
				listCount = rset.getInt(1);
			}
			
		}finally {
			close(stmt);
			close(rset);
		}
		return listCount;
	}

	/** 게시글 목록 조회 DAO
	 * @param conn
	 * @param pInfo
	 * @return bList
	 * @throws Exception
	 */
	public List<Board> selectBoardList(Connection conn, PageInfo pInfo) throws Exception {
		List<Board> bList = null;
		
		String query = prop.getProperty("selectBoardList");
		
		try {
			// SQL 구문 조건절에 대입할 변수 생성
			int startRow = (pInfo.getCurrentPage() -1) * pInfo.getLimit() + 1;
			int endRow = startRow + pInfo.getLimit() -1;
			
			pstmt = conn.prepareStatement(query);
			
			pstmt.setInt(1, startRow);
			pstmt.setInt(2, endRow);
			
			rset = pstmt.executeQuery();
			
			bList = new ArrayList<Board>();
			
			while(rset.next()) {
				Board board = new Board(
						rset.getInt("BOARD_NO"), 
						rset.getNString("BOARD_TITLE"), 
						rset.getNString("MEMBER_ID"), 
						rset.getInt("READ_COUNT"), 
						rset.getNString("CATEGORY_NM"), 
						rset.getTimestamp("BOARD_CREATE_DT"));
				bList.add(board);
			}
			
		}finally {
			close(rset);
			close(pstmt);
		}
		return bList;
	}

	/** 게시글 상세 조회 DAO
	 * @param conn
	 * @param boardNo
	 * @return board
	 * @throws Exception
	 */
	public Board selectBoard(Connection conn, int boardNo) throws Exception {
		Board board = null;
		
		String query = prop.getProperty("selectBoard");
		
		try {
			pstmt = conn.prepareStatement(query);
			pstmt.setInt(1, boardNo);
			rset = pstmt.executeQuery();
			
			if(rset.next()) {
				board = new Board();
				
				board.setBoardNo( rset.getInt("BOARD_NO") );
				board.setBoardTitle( rset.getString("BOARD_TITLE") );
				board.setBoardContent( rset.getString("BOARD_CONTENT") );
				board.setMemberId( rset.getString("MEMBER_ID") );
				board.setReadCount( rset.getInt("READ_COUNT") );
				board.setBoardCreateDate( rset.getTimestamp("BOARD_CREATE_DT") );
				board.setBoardModifyDate( rset.getTimestamp("BOARD_MODIFY_DT") );
				board.setCategoryName( rset.getString("CATEGORY_NM") );
			}
			
		}finally {
			close(rset);
			close(pstmt);
		}
		return board;
	}

	/** 조회수 증가 DAO
	 * @param conn
	 * @param boardNo
	 * @return result
	 * @throws Exception
	 */
	public int increaseReadCount(Connection conn, int boardNo) throws Exception {
		int result = 0;
		
		String query = prop.getProperty("increaseReadCount");
		
		try {
			pstmt = conn.prepareStatement(query);
			pstmt.setInt(1, boardNo);
			
			result = pstmt.executeUpdate();
			
		}finally {
			close(pstmt);
		}
		
		return result;
	}

	/** 다음 게시글 번호 조회 DAO
	 * @param conn
	 * @return boardNo
	 * @throws Exception
	 */
	public int selectNextNo(Connection conn) throws Exception {
		int boardNo = 0;
		
		String query = prop.getProperty("selectNextNo");
		
		try {
			stmt = conn.createStatement();
			rset = stmt.executeQuery(query);
			
			if(rset.next()) {
				boardNo = rset.getInt(1);
			}
			
		}finally {
			close(rset);
			close(stmt);
		}
		
		return boardNo;
	}

	/** 게시글 삽입 DAO
	 * @param conn
	 * @param map
	 * @return result
	 * @throws Exception
	 */
	public int insertBoard(Connection conn, Map<String, Object> map) throws Exception {
		int result = 0;
		
		String query = prop.getProperty("insertBoard");
		
		try {
			pstmt = conn.prepareStatement(query);
			pstmt.setInt(1, (int)map.get("boardNo"));
			pstmt.setString(2, (String)map.get("boardTitle"));
			pstmt.setString(3, (String)map.get("boardContent"));
			pstmt.setInt(4, (int)map.get("boardWriter"));
			pstmt.setInt(5, (int)map.get("categoryCode"));
			
			result = pstmt.executeUpdate();
		}finally {
			close(pstmt);
		}
		
		return result;
	}

	/** 파일 정보 삽입 DAO
	 * @param conn
	 * @param at
	 * @return result
	 * @throws Exception
	 */
	public int insertAttachment(Connection conn, Attachment at) throws Exception {
		int result = 0;
		
		String query = prop.getProperty("insertAttachment");
		
		try {
			pstmt = conn.prepareStatement(query);
			
			pstmt.setNString(1, at.getFilePath());
			pstmt.setNString(2, at.getFileName());
			pstmt.setInt(3, at.getFileLevel());
			pstmt.setInt(4, at.getParentBoardNo());
			
			result = pstmt.executeUpdate();
		}finally {
			close(pstmt);
			
		}
		return result;
	}

	/** 게시글에 포함된 이미지 목록 조회 DAO
	 * @param conn
	 * @param boardNo
	 * @return fList
	 * @throws Exception
	 */
	public List<Attachment> selectBoardFiles(Connection conn, int boardNo) throws Exception {
		List<Attachment> fList = null;
		
		String query = prop.getProperty("selectBoardFiles");
		
		try {
			pstmt = conn.prepareStatement(query);
			
			pstmt.setInt(1, boardNo);
			
			rset = pstmt.executeQuery();
			
			fList = new ArrayList<Attachment>();
			
			while(rset.next()) {
				Attachment at = new Attachment(
						rset.getInt("FILE_NO"), 
						rset.getNString("FILE_NAME"), 
						rset.getInt("FILE_LEVEL"));
				
				at.setFilePath(rset.getNString("FILE_PATH"));
				
				fList.add(at);
			}
			
		}finally {
			close(rset);
			close(pstmt);
		}
		
		return fList;
	}

	/** 썸네일 목록 조회 DAO
	 * @param conn
	 * @param pInfo
	 * @return fList
	 * @throws Exception
	 */
	public List<Attachment> selectThumbnailList(Connection conn, PageInfo pInfo) throws Exception {
		List<Attachment> fList = null;
		
		String query = prop.getProperty("selectThumbnailList");
		
		try {
			int startRow = (pInfo.getCurrentPage() - 1) * pInfo.getLimit() + 1;
			int endRow = startRow + pInfo.getLimit() - 1;
					
			pstmt = conn.prepareStatement(query);
			
			pstmt.setInt(1, startRow);
			pstmt.setInt(2, endRow);
			
			rset = pstmt.executeQuery();
			
			fList = new ArrayList<Attachment>();
			
			while(rset.next()) {
				
				Attachment at = new Attachment();
				at.setFileName(rset.getNString("FILE_NAME"));
				at.setParentBoardNo(rset.getInt("PARENT_BOARD_NO"));
				
				fList.add(at);
			}
			
		}finally {
			close(rset);
			close(pstmt);
		}
		
		return fList;
	}

	 /** 게시글 수정 DAO
	    * @param conn
	    * @param map
	    * @return result
	    * @throws Exception
	    */
	   public int updateBoard(Connection conn, Map<String, Object> map) throws Exception {
	      int result = 0;
	      
	      String query = prop.getProperty("updateBoard");
	      
	      try {
	         pstmt = conn.prepareStatement(query);
	         pstmt.setString(1, (String)map.get("boardTitle"));
	         pstmt.setString(2, (String)map.get("boardContent"));
	         pstmt.setInt(3, (int)map.get("categoryCode"));
	         pstmt.setInt(4, (int)map.get("boardNo"));

	         result = pstmt.executeUpdate();
	         
	      } finally {
	         close(pstmt);
	      }
	      return result;
	   }

	   
	   
	   /** 파일 정보 수정 DAO
	    * @param conn
	    * @param newFile
	    * @return result
	    * @throws Exception
	    */
	   public int updateAttachment(Connection conn, Attachment newFile) throws Exception {
	      int result =0;
	      
	      String query = prop.getProperty("updateAttachment");
	      
	      try{
	         pstmt = conn.prepareStatement(query);
	         pstmt.setString(1, newFile.getFilePath());
	         pstmt.setString(2, newFile.getFileName());
	         pstmt.setInt(3, newFile.getFileNo());
	         
	         result = pstmt.executeUpdate();
	      }finally {
	         close(pstmt);
	      }
	      return result;
	   }
	}
```
<br><br>

### com.kh.wsp/board/exception

- FileInsertFailedException.java

```java
package com.kh.wsp.board.model.exception;

// 파일 정보 삽입 실패시 발생할 사용자 정의 예외
public class FileInsertFailedException extends Exception {

	public FileInsertFailedException() {
		super();
	}
	
	public FileInsertFailedException(String message) {
		super(message);
	}
}
```

<br><br>

### com.kh.wsp/board/common

- MyFileRenamePolicy.java

```java
package com.kh.wsp.common;

import java.io.File;
import java.text.SimpleDateFormat;
import java.util.Date;

import com.oreilly.servlet.multipart.FileRenamePolicy;

public class MyFileRenamePolicy implements FileRenamePolicy{
	
	@Override
	public File rename(File originalFile) {
		
		// 업로드된 시간을 파일명에 작성 + 5자리 랜덤 숫자 추가
		//20210107101311_12345.jpg
		
		long currentTime = System.currentTimeMillis();
		
		SimpleDateFormat ft = new SimpleDateFormat("yyyyMMddHHmmss");
		
		int random = (int)(Math.random() * 100000); // 0~99999까지 5자리 난수
		
		String str = "_" + String.format("%05d", random);
		// %d : 정수
		// %5d : 5칸 오른쪽 정렬된 정수
		// %05d : 5칸 오른쪽 정렬된 정수, 빈칸은 0
		
		// 파일명을 변경해도 확장자는 유지 되어야 하므로
		// 업로드된 원본 파일의 확장자 부분만 얻어오기
		int dot = originalFile.getName().lastIndexOf("."); 
		// 원본 파일명에서 제일 마지막 .의 위치 얻어오기, 없으면 -1 반환
		
		String ext = ""; // 확장자를 저장할 변수
		
		if( dot != -1) {
			ext = originalFile.getName().substring(dot);
		}
		
		String fileName = ft.format(new Date(currentTime)) + str + ext;
						   // 업로드된 진짜 시간을 ft로 나타내라
		
		System.out.println(originalFile.getParent());
		
		return new File(originalFile.getParent(), fileName);
	}
}
```

<br><br>

### com.kh.wsp/sql/board

- board-query.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>

<!-- 전체 게시글 수 조회 -->
<entry key="getListCount">
SELECT COUNT(*) FROM V_BOARD
WHERE BOARD_STATUS = 'Y'
</entry>

<!-- 지정된 페이지 게시글 목록 조회 -->
<entry key="selectBoardList">
SELECT * FROM
(SELECT ROWNUM RNUM, V.*
 FROM
    (SELECT * FROM V_BOARD WHERE BOARD_STATUS = 'Y' ORDER BY BOARD_NO DESC) V)
WHERE RNUM BETWEEN ? AND ?
</entry>

<!-- 게시글 상세 조회 -->
<entry key="selectBoard">
SELECT * FROM V_BOARD
WHERE BOARD_NO = ?
AND BOARD_STATUS = 'Y'
</entry>

<entry key="increaseReadCount">
UPDATE BOARD SET
READ_COUNT = READ_COUNT + 1
WHERE BOARD_NO = ?
</entry>

<!-- 다음 게시글 번호 조회 -->
<entry key="selectNextNo">
SELECT SEQ_BNO.NEXTVAL FROM DUAL
</entry>

<!-- 게시글 삽입 -->
<entry key="insertBoard">
INSERT INTO BOARD(BOARD_NO, BOARD_TITLE, BOARD_CONTENT, BOARD_WRITER, CATEGORY_CD)
VALUES(?, ?, ?, ?, ?)
</entry>

<!-- 파일 정보 삽입 -->
<entry key="insertAttachment">
INSERT INTO ATTACHMENT
VALUES(SEQ_FNO.NEXTVAL, ?, ?, ?, ?)
</entry>

<!-- 게시글에 포함된 이미지 목록 조회 -->
<entry key="selectBoardFiles">
SELECT FILE_NO, FILE_NAME, FILE_LEVEL, FILE_PATH 
FROM ATTACHMENT
WHERE PARENT_BOARD_NO = ?
ORDER BY FILE_LEVEL
</entry>

<!-- 썸네일 목록 조회 -->
<entry key="selectThumbnailList">
SELECT * FROM ATTACHMENT
WHERE PARENT_BOARD_NO 
IN(SELECT BOARD_NO FROM
    (SELECT ROWNUM RNUM, V.* FROM
        (SELECT BOARD_NO FROM V_BOARD
        WHERE BOARD_STATUS = 'Y'
        ORDER BY BOARD_NO DESC) V)
     WHERE RNUM BETWEEN ? AND ?)
AND FILE_LEVEL = 0
</entry>

<!-- 게시글 수정 -->
<entry key="updateBoard">
UPDATE BOARD SET
BOARD_TITLE = ?,
BOARD_CONTENT = ?,
CATEGORY_CD = ?,
BOARD_MODIFY_DT = SYSDATE
WHERE BOARD_NO = ?
</entry>

<!-- 파일 정보 수정 -->
<entry key="updateAttachment">
UPDATE ATTACHMENT SET
FILE_PATH = ?,
FILE_NAME = ?
WHERE FILE_NO = ?
</entry>

</properties>
```
<br><br>

### WebContent/WEB-INF/views/board

- BoardList.jsp

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>


<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시판</title>
<style>
.pagination {
   justify-content: center;
}

#searchForm {
   position: relative;
}

#searchForm>* {
   top: 0;
}

.boardTitle>img {
   width: 50px;
   height: 50px;
}

#list-table th {
   text-align: center;
}

#list-table td:not(:nth-of-type(3)) {
   text-align: center;
}

.list-wrapper{
   min-height: 540px;
}

#list-table td:hover{
   cursor : pointer;
}

/* 세로 가운데 정렬*/
#list-table td{
  vertical-align: middle;
  /* vertical-align : inline, inline-block 요소에만 적용 가능(td는 inline-block)*/
	
}

</style>

</head>
<body>
   <jsp:include page="../common/header.jsp"></jsp:include>
   <div class="container my-5">
      
      <h1>게시판</h1>
      
         <div class="list-wrapper">
            <table class="table table-hover table-striped my-5" id="list-table">
               <thead>
                  <tr>
                     <th>글번호</th>
                     <th>카테고리</th>
                     <th>제목</th>
                     <th>작성자</th>
                     <th>조회수</th>
                     <th>작성일</th>
                  </tr>
               </thead>
               
               <%-- 게시글 목록 출력 --%>
               <tbody>
                  <c:choose>
                     <c:when test="${empty bList}">
                        <tr>
                           <td colspan="6">존재하는 게시글이 없습니다.</td>
                        </tr>
                     </c:when>
                     
                     <c:otherwise> <%-- 조회된 게시글 목록이 있을 때 --%>
                        <c:forEach var="board" items="${bList}">
                           <tr>
                              <td>${board.boardNo}</td>
                              <td>${board.categoryName}</td>
                              
                              <td class="boardTitle">
	                              <%-- 썸네일 출력 --%>
	                              <c:forEach var="thumbnail" items="${fList}">
	                              	
	                              	<%-- 현재 출력하려는 게시글 번호와 썸네일 목록 중 
	                              		  부모게시글 번호가 일치하는 썸네일 정보가 있다면 --%>
	                              	<c:if test="${board.boardNo == thumbnail.parentBoardNo}">
	                              		
	                              		<img src="${contextPath}/resources/uploadImages/${thumbnail.fileName}">
	                              		
	                              	</c:if>
	                              	
	                              </c:forEach>
	                              
	                              
	                              ${board.boardTitle}
                              </td>
                              
                              <td>${board.memberId}</td>
                              <td>${board.readCount}</td>
                              <td>
                                 <%-- 날짜 출력 모양 지정 --%>
                                 <fmt:formatDate var="createDate"
                                     value="${board.boardCreateDate}"
                                      pattern="yyyy-MM-dd"/>  
                                      
                                                                            
                                 <fmt:formatDate var="today"
                                     value="<%= new java.util.Date() %>"
                                      pattern="yyyy-MM-dd"/> 
                                         
                                 
                                      
                                 <c:choose>
                                    <%-- 글 작성일이 오늘이 아닐 경우 --%>
                                    <c:when test="${createDate != today }">
                                       ${createDate}
                                    </c:when>
                                    
                                    <%-- 글 작성일이 오늘일 경우 --%>
                                    <c:otherwise>
                                       <fmt:formatDate value="${board.boardCreateDate}"
                                      pattern="HH:mm"/>    
                                    </c:otherwise>
                                 
                                 </c:choose>                                    
                              </td>
                           </tr>
                        </c:forEach>
                     </c:otherwise>
                  </c:choose>
               </tbody>
            </table>
         </div>


         <%-- 로그인이 되어있는 경우 --%>
         <c:if test="${!empty loginMember}">
         	<button type="button" class="btn btn-primary float-right" id="insertBtn" 
         	 onclick="location.href = '${contextPath}/board/insertForm.do'">글쓰기</button>
         </c:if>
         
         <%---------------------- Pagination ----------------------%>
         <%-- 페이징 처리 주소를 쉽게 사용할 수 있도록 미리 변수에 저장 --%>
         <c:choose>
            <%-- 검색 내용이 파라미터에 존재할 때 == 검색을 통해 만들어진 페이지인가? --%>
            <c:when test="${!empty param.sk && !empty param.sv}">
               <c:url var="pageUrl" value="/search.do"/>
               
               <!-- 쿼리스트링으로 사용할 내용을 변수에 저장 -->
               <c:set var="searchStr" value="&sk=${param.sk}&sv=${param.sv}"/>
            </c:when>
            
            <c:otherwise>
              <c:url var="pageUrl" value="/board/list.do"/>
            </c:otherwise>
            
         </c:choose>
         
         
         
         
         
         <!-- 화살표에 들어갈 주소를 변수로 생성 -->
         <%-- 
            검색을 안했을 때 : /board/list.do?cp=1
            검색을 했을 때 :  /search.do?cp=1&sk=title&sv=49
          --%>
         
         <c:set var="firstPage" value="${pageUrl}?cp=1${searchStr}"/>
         <c:set var="lastPage" value="${pageUrl}?cp=${pInfo.maxPage}${searchStr}"/>
         
         <%-- EL을 이용한 숫자 연산의 단점 : 연산이 자료형에 영향을 받지 않는다. --%>
         <%--
          <fmt : parseNumber> : 숫자 형태를 지정하여 변수 선언 
          integerOnly="true" : 정수로만 숫자 표현(소수점 버림)
         --%>
         
         <fmt:parseNumber var="c1" value="${(pInfo.currentPage - 1) / 10}" integerOnly="true"/>
         <fmt:parseNumber var="prev" value="${c1 * 10}" integerOnly="true"/>
         <c:set var="prevPage" value="${pageUrl}?cp=${prev}${searchStr}" />
         
         <fmt:parseNumber var="c2" value="${(pInfo.currentPage + 9) / 10 }" integerOnly="true" />
         <fmt:parseNumber var="next" value="${ c2 * 10 + 1}" integerOnly="true" />
         <c:set var="nextPage" value="${pageUrl}?cp=${next}${searchStr}" />
         
         
         
         <div class="my-5">
            <ul class="pagination">
               <%-- 현재 페이지가 10페이지 초과인 경우 --%>
               <c:if test="${pInfo.currentPage > 10}">
                  <li> <%-- 첫 페이지로 이동(<<) --%>
                     <a class="page-link" href="${firstPage}">&lt;&lt;</a>
                  </li>
                  <li> <%-- 이전 페이지로 이동(<) --%>
                     <a class="page-link" href="${prevPage}">&lt;</a>
                  </li>
               </c:if>
               
               <!--  페이지 목록   -->
               <c:forEach var="page" begin="${pInfo.startPage}" end="${pInfo.endPage}">
                  <c:choose>
                     <c:when test="${pInfo.currentPage == page}">
                        <li>
                           <a class="page-link">${page}</a>
                        </li>
                     </c:when>
                     
                     <c:otherwise>
                        <li>
                           <a class="page-link" href="${pageUrl}?cp=${page}${searchStr}">${page}</a>
                        </li>
                     </c:otherwise>
                  </c:choose>
               </c:forEach>
               

            <%-- 다음 페이지가 마지막 페이지 이하인 경우 --%>
            <c:if test="${ next <= pInfo.maxPage}">
               <li>
                  <%-- 다음 페이지로 이동(>) --%> 
                  <a class="page-link" href="${nextPage}">&gt;</a>
               </li>
               <li>
                  <%-- 마지막 페이지로 이동(>>) --%> 
                  <a class="page-link" href="${lastPage}">&gt;&gt;</a>
               </li>
            </c:if>

         </ul>
         </div>
      
      
         <!-- 검색창 -->
         <div class="my-5">
            <form action="${contextPath}/search.do" method="GET" class="text-center" id="searchForm">
               <select name="sk" class="form-control" style="width: 100px; display: inline-block;">
                  <option value="title">글제목</option>
                  <option value="content">내용</option>
                  <option value="titcont">제목+내용</option>
                  <option value="writer">작성자</option>
               </select>
               <input type="text" name="sv" class="form-control" style="width: 25%; display: inline-block;">
               <button class="form-control btn btn-primary" style="width: 100px; display: inline-block;">검색</button>
            </form>


         </div>
   </div>
   <jsp:include page="../common/footer.jsp"></jsp:include>


   <script>
      // 게시글 상세보기 기능 (jquery를 통해 작업)
      $("#list-table td").on("click",function(){
         
         // 게시글 번호 얻어오기
         var boardNo = $(this).parent().children().eq(0).text();
         //console.log(boardNo);
         // 클릭이 되는지 테스트
         
         var url = "${contextPath}/board/view.do?cp=${pInfo.currentPage}&no=" + boardNo + "${searchStr}";
         
         location.href = url;
         
      });
      
      
      // 검색 내용이 있을 경우 검색창에 해당 내용을 작성해두는 기능
      (function(){
    	  var searchKey = "${param.sk}";
    	  // 파라미터 중 sk가 있을 경우 ex)"49"
    	  // 파라미터 중 sk가 없을 경우 ex) ""
    	  var searchValue = "${param.sv}";
    	  
    	  // 검색창 select의 option을 반복 접근
    	  $("select[name=sk] > option").each(function(index, item){
    		  // index : 현재 접근 중인 요소의 인덱스
    		  // item : 현재 접근 중인 요소
    		  
    		  		// title          title
    		  if( $(item).val() == searchKey ){ // 제목으로 검색한 경우
    			 $(item).prop("selected", true);
    		  }
    	  });
    	  
    	  // 검색어 입력창에 searchValue 값 출력
    	  $("input[name=sv]").val(searchValue);
    	  
      })();
   </script>
</body>
</html>
```
<br><br>

- BoardView.jsp

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시글</title>
<style>
   #board-area{ min-height: 700px; margin-bottom : 100px; }
   #board-content{ padding-bottom:150px;}

   .boardImgArea{
      height: 300px;
   }

   .boardImg{
      width : 100%;
      height: 100%;
      
      max-width : 300px;
      max-height: 300px;
      
      margin : auto;
   }
   
   /* 이미지 화살표 색 조정
   -> fill='%23000' 부분의 000을
      RGB 16진수 값을 작성하여 변경 가능 
    */
   .carousel-control-prev-icon {
       background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23000' viewBox='0 0 8 8'%3E%3Cpath d='M5.25 0l-4 4 4 4 1.5-1.5-2.5-2.5 2.5-2.5-1.5-1.5z'/%3E%3C/svg%3E") !important;
   }
   
   .carousel-control-next-icon {
        background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23000' viewBox='0 0 8 8'%3E%3Cpath d='M2.75 0l-1.5 1.5 2.5 2.5-2.5 2.5 1.5 1.5 4-4-4-4z'/%3E%3C/svg%3E") !important;
   }
   
   .replyWrite > table{
      width: 90%;
      align: center;
   }
   
   #replyContentArea{ width: 90%; }
   
   #replyContentArea > textarea{
       resize: none;
       width: 100%;
   }
   
   #replyBtnArea{
       width: 100px;
       text-align: center;
   }
   
   .rWriter{ margin-right: 30px;}
   .rDate{
      font-size: 0.7em;
      color : gray;
   }
   
   #replyListArea{
      list-style-type: none;
   }
   
   .board-dateArea{
      font-size: 14px;
   }
   
   /* 이미지 선택 색 변경*/
   .carousel-indicators > li{
      background-color: #ccc !important;
   }
   
</style>
</head>
<body>
	<jsp:include page="../common/header.jsp"></jsp:include>
	<div class="container  my-5">

		<div>

			<div id="board-area">

				<!-- Category -->
				<h6 class="mt-4">카테고리 : [${board.categoryName}]</h6>
				
				<!-- Title -->
				<h3 class="mt-4">${board.boardTitle}</h3>

				<!-- Writer -->
				<p class="lead">
					작성자 : ${board.memberId}
				</p>

				<hr>

				<!-- Date -->
				<p>
					<span class="board-dateArea">
						작성일 : <fmt:formatDate value="${board.boardCreateDate}" pattern="yyyy년 MM월 dd일 HH:mm:ss" />
						<br>
						마지막 수정일 : <fmt:formatDate value="${board.boardModifyDate}" pattern="yyyy년 MM월 dd일 HH:mm:ss" />
					</span>
			 		<span class="float-right">조회수 ${board.readCount}</span>
				</p>

				<hr>
				<!-- 이미지 출력 -->
                <div class="carousel slide boardImgArea" id="board-image">
                <c:if test="${!empty fList}">
	               <!-- 이미지 선택 버튼 -->
	               <ol class="carousel-indicators">
	                  <c:forEach var="file" items="${fList}" varStatus="vs">
	                     
	                     <li data-slide-to="${vs.index }" data-target="#board-image"  
	                           <c:if test="${vs.first}"> class="active" </c:if> 
	                     >                      
	                     </li>
	                  
	                  </c:forEach>
	               </ol>
               
               
               <!-- 출력되는 이미지 -->
               <div class="carousel-inner">
                  <c:forEach var="file" items="${fList}" varStatus="vs">
                  
                     <div class="carousel-item <c:if test="${vs.first}">active</c:if>">
                     
                        <img class="d-block w-100 boardImg" id="${file.fileNo}" 
                           src="${contextPath}/resources/uploadImages/${file.fileName}">
                     </div>
                     
                  </c:forEach>
               
               </div> 
               
               <!-- 좌우 화살표 -->
               <a class="carousel-control-prev" href="#board-image" data-slide="prev"><span class="carousel-control-prev-icon"></span> <span class="sr-only">Previous</span></a> 
               <a class="carousel-control-next" href="#board-image" data-slide="next"><span class="carousel-control-next-icon"></span> <span class="sr-only">Next</span></a>
            </div>
            </c:if>
				
				
				
				
				
				
				
				
				
				
				
				
				
				

				<!-- Content -->
				<div id="board-content">${board.boardContent}</div>
				

				<hr>
				 
				
				<div>
				
					<%-- 로그인된 회원과 해당 글 작성자가 같은 경우--%>
					<c:if test="${!empty loginMember && (board.memberId) == loginMember.memberId }">
						<button id="deleteBtn" class="btn btn-primary float-right">삭제</button> 
						
						
						<%-- 
						
						검색 하지 않은 경우 : 상세조회 -> 수정 버튼 클릭 -> 수정 화면 -> 수정 성공 -> 상세 조회 ?
																	cp=1&no=505
																	
						검색한 경우 : 검색목록 -> 상세 조회 -> 수정 버튼 클릭 -> 수정 화면 -> 수정 성공 -> 상세 조회
												cp=1&no=505&sk=title&sv=파일 --%>
						
						
						<%-- 게시글 수정 후 상세조회 페이지로 돌아오기 위한 url 조합 --%>	
						
						<c:if test="${!empty param.sv && !empty param.sk}">
						 <%-- 검색을 통해 들어온 상세 조회 페이지인 경우 --%>
						
							<c:set var="searchStr" value="&sk=${param.sk}&sv=${param.sv}" />
						
						</c:if>										
						
						<a href="updateForm.do?cp=${param.cp}&no=${param.no}${searchStr}" class="btn btn-primary float-right ml-1 mr-1">수정</a>
					</c:if>
					
					<%--
						상대경로 작성법
						 - ../ : 현재 위치에서 한단계 상위(주소 제일 마지막 /보다 왼쪽으로 한칸 앞 /)
						 
						 http://localhost:8080/wsp/board/view.do 에서
						 http://localhost:8080/wsp/search.do 으로
						 
						 검색 -> 게시글 상세조회 -> 목록 -> 상세조회 전 페이지
					 --%>
					
					<c:choose>
						<c:when test="${!empty param.sk && !empty param.sv}">
							<c:url var="goToList" value="../search.do">
								<c:param name="cp">${param.cp}</c:param>
								<c:param name="sk">${param.sk}</c:param>
								<c:param name="sv">${param.sv}</c:param>
							</c:url>
						</c:when>
						
						<c:otherwise>
							<c:url var="goToList" value="/board/list.do">
								<c:param name="cp">${param.cp}</c:param>
							</c:url>
						</c:otherwise>
					</c:choose>
					
					
					<a href="${goToList}" class="btn btn-primary float-right">목록으로</a>
				</div>
			</div>



		</div>
	</div>
	<jsp:include page="../common/footer.jsp"></jsp:include>
	
	
	<script>
		
	</script>
</body>
</html>
```

<br><br>

- boardInsert.jsp

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시판</title>
<style>
    .insert-label {
      display: inline-block;
      width: 80px;
      line-height: 40px
    }
    
    .boardImg{
    	cursor : pointer;
    }
</style>
</head>
<body>
		<jsp:include page="../common/header.jsp"></jsp:include>

		<div class="container my-5">

			<h3>게시글 등록</h3>
			<hr>
			<!-- 파일 업로드를 위한 라이브러리 cos.jar 라이브러리 다운로드(http://www.servlets.com/) -->
			
			<!-- 
				- enctype : form 태그 데이터가 서버로 제출 될 때 인코딩 되는 방법을 지정. (POST 방식일 때만 사용 가능)
				- application/x-www-form-urlencoded : 모든 문자를 서버로 전송하기 전에 인코딩 (form태그 기본값)
				- multipart/form-data : 모든 문자를 인코딩 하지 않음.(원본 데이터가 유지되어 이미지, 파일등을 서버로 전송 할 수 있음.) 
			-->
			<form action="${contextPath}/board/insert.do" method="post" 
				  enctype="multipart/form-data" role="form" onsubmit="return boardValidate();">

				<div class="mb-2">
					<label class="input-group-addon mr-3 insert-label">카테고리</label> 
					<select	class="custom-select" id="categoryCode" name="categoryCode" style="width: 150px;">
						<option value="10">운동</option>
						<option value="20">영화</option>
						<option value="30">음악</option>
						<option value="40">요리</option>
						<option value="50">게임</option>
						<option value="60">기타</option>
					</select>
				</div>
				<div class="form-inline mb-2">
					<label class="input-group-addon mr-3 insert-label">제목</label> 
					<input type="text" class="form-control" id="boardTitle" name="boardTitle" size="70">
				</div>

				<div class="form-inline mb-2">
					<label class="input-group-addon mr-3 insert-label">작성자</label>
					<h5 class="my-0" id="writer">${loginMember.memberId}</h5>
				</div>


				<div class="form-inline mb-2">
					<label class="input-group-addon mr-3 insert-label">작성일</label>
					<h5 class="my-0" id="today"></h5>
				</div>

				<hr>

				<div class="form-inline mb-2">
					<label class="input-group-addon mr-3 insert-label">썸네일</label>
					<div class="boardImg" id="titleImgArea">
						<img id="titleImg" width="200" height="200">
					</div>
				</div>

				<div class="form-inline mb-2">
					<label class="input-group-addon mr-3 insert-label">업로드<br>이미지</label>
					<div class="mr-2 boardImg" id="contentImgArea1">
						<img id="contentImg1" width="150" height="150">
					</div>

					<div class="mr-2 boardImg" id="contentImgArea2">
						<img id="contentImg2" width="150" height="150">
					</div>

					<div class="mr-2 boardImg" id="contentImgArea3">
						<img id="contentImg3" width="150" height="150">
					</div>
				</div>


				<!-- 파일 업로드 하는 부분 -->
				<div id="fileArea">
					<!--  multiple 속성
						- input 요소 하나에 둘 이상의 값을 입력할 수 있음을 명시 (파일 여러개 선택 가능)
					 -->
					<input type="file" id="img0" name="img0" onchange="LoadImg(this,0)"> 
					<input type="file" id="img1" name="img1" onchange="LoadImg(this,1)"> 
					<input type="file" id="img2" name="img2" onchange="LoadImg(this,2)"> 
					<input type="file" id="img3" name="img3" onchange="LoadImg(this,3)"> 
				</div>

				<div class="form-group">
					<div>
						<label for="content">내용</label>
					</div>
					<textarea class="form-control" id="boardContent" name="boardContent" rows="15" style="resize: none;"></textarea>
				</div>


				<hr class="mb-4">

				<div class="text-center">
					<button type="submit" class="btn btn-primary">등록</button>
					<button type="button" class="btn btn-primary">목록으로</button>
				</div>

			</form>
		</div>

		<jsp:include page="../common/footer.jsp"></jsp:include>
		
		
	<script>
		(function printToday(){
			// 오늘 날짜 출력 
	 		var today = new Date();
			var month = (today.getMonth()+1);
			var date = today.getDate();
	
	  	var str = today.getFullYear() + "-"
	        		+ (month < 10 ? "0"+month : month) + "-"
	        		+ (date < 10 ? "0"+date : date);
			$("#today").html(str);
		})();

		// 유효성 검사 
		function boardValidate() {
			if ($("#boardTitle").val().trim().length == 0) {
				alert("제목을 입력해 주세요.");
				$("#boardTitle").focus();
				return false;
			}

			if ($("#boardContent").val().trim().length == 0) {
				alert("내용을 입력해 주세요.");
				$("#boardContent").focus();
				return false;
			}
		}
		
		// 이미지 영역을 클릭할 때 파일 첨부 창이 뜨도록 설정하는 함수
		$(function(){
			$("#fileArea").hide(); // #fileArea 요소를 숨김.
			
			$(".boardImg").on("click", function(){ // 이미지 영역이 클릭되었을 때
				
				// 클릭한 이미지 영역 인덱스 얻어오기
				var index = $(".boardImg").index(this);
							// -> 클릭된 요소가 .boardImg 중 몇번째 인덱스인지 반환
							
				//console.log(index);
							
				// 클릭된 영역 인덱스에 맞는 input file 태그 클릭
				$("#img" + index).click();
				
			});
			
		});
		
		 
	   // 각각의 영역에 파일을 첨부 했을 경우 미리 보기가 가능하도록 하는 함수
	   function LoadImg(value, num) {
		   // value.files : 파일이 선택되어 있으면 true
		   // value.files[0] : 여러 파일 중 첫 번째 파일이 업로드 되어 있으면 true
		   
		   if(value.files && value.files[0]){ // 해당 요소에 업로드된 파일이 있을 경우
			   
			   var reader = new FileReader();
				// 자바스크립트 FileReader
	        	// 웹 애플리케이션이 비동기적으로 데이터를 읽기 위하여 
	        	// 읽을 파일을 가리키는 File 혹은 Blob객체를 이용해 
	        	// 파일의 내용을 읽고 사용자의 컴퓨터에 저장하는 것을 가능하게 해주는 객체
	        	
	        	reader.readAsDataURL(value.files[0]);
	        	// FileReader.readAsDataURL()
		      	// 지정된의 내용을 읽기 시작합니다. 
		      	// Blob완료되면 result속성 data:에 파일 데이터를 나타내는 URL이 포함 됩니다.
		      	
		      	reader.onload = function(e){
		      	// FileReader.onload
				// load 이벤트의 핸들러. 이 이벤트는 읽기 동작이 성공적으로 완료 되었을 때마다 발생합니다.
				
				
				// 읽어들인 내용(이미지 파일)을 화면에 출력
				
				// num == 0, 1, 2, 3 중 하나 == onchange="LoadImg(this,0)"
				$(".boardImg").eq(num).children("img").attr("src", e.target.result);
		      	// e.target.result : 파일 읽기 동작을 성공한 요소가 읽어들인 파일 내용

		      	}
		   }
		   
		}
	   
	</script>
</body>
</html>
```

<br><br>

- boardUpdate.jsp

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시판</title>
<style>
    .insert-label {
      display: inline-block;
      width: 80px;
      line-height: 40px
    }
    
    .boardImg{
    	cursor : pointer;
    }
</style>
</head>
<body>
	<jsp:include page="../common/header.jsp"></jsp:include>

	<div class="container my-5">

		<h3>게시글 수정</h3>
		<hr>
		
		<c:if test="${!empty param.sk && !empty param.sv}">
			<c:set var="searchStr" value="&sk=${param.sk}&sv=${param.sv}"/>
		</c:if>
		
		<form action="update.do?cp=${param.cp}&no=${param.no}${searchStr}" method="post"
			  enctype="multipart/form-data" role="form" onsubmit="return updateValidate();">

			<div class="mb-2">
				<label class="input-group-addon mr-3 insert-label">카테고리</label> 
				<select	class="custom-select" id="categoryCode" name="categoryCode" style="width: 150px;">
					<option value="10">운동</option>
					<option value="20">영화</option>
					<option value="30">음악</option>
					<option value="40">요리</option>
					<option value="50">게임</option>
					<option value="60">기타</option>
				</select>
			</div>
			<div class="form-inline mb-2">
				<label class="input-group-addon mr-3 insert-label">제목</label> 
				<input type="text" class="form-control" id="boardTitle" name="boardTitle" size="70" value="${board.boardTitle }">
			</div>

			<div class="form-inline mb-2">
				<label class="input-group-addon mr-3 insert-label">작성자</label>
				<h5 class="my-0" id="writer">${board.memberId }</h5>
			</div>


			<div class="form-inline mb-2">
				<label class="input-group-addon mr-3 insert-label">작성일</label> <fmt:formatDate value="${board.boardCreateDate }" pattern="yyyy년 MM월 dd일 HH:mm:ss"/>
			</div>
			<hr>

			<div class="form-inline mb-2">
				<label class="input-group-addon mr-3 insert-label">썸네일</label>
				<div class="boardImg" id="titleImgArea">
					<img id="titleImg" width="200" height="200">
				</div>
					<button type="button" id="del1">삭제</button>
			</div>

			<div class="form-inline mb-2">
				<label class="input-group-addon mr-3 insert-label">업로드<br>이미지</label>
				<div class="mr-2 boardImg" id="contentImgArea1">
					<img id="contentImg1" width="150" height="150">
				</div>

				<div class="mr-2 boardImg" id="contentImgArea2">
					<img id="contentImg2" width="150" height="150">
				</div>

				<div class="mr-2 boardImg" id="contentImgArea3">
					<img id="contentImg3" width="150" height="150">
				</div>
			</div>


			<!-- 파일 업로드 하는 부분 -->
			<div id="fileArea">
				<input type="file" id="img0" name="img0" onchange="LoadImg(this,0)"> 
				<input type="file" id="img1" name="img1" onchange="LoadImg(this,1)"> 
				<input type="file" id="img2" name="img2" onchange="LoadImg(this,2)"> 
				<input type="file" id="img3" name="img3" onchange="LoadImg(this,3)">
			</div>

			<div class="form-group">
				<div>
					<label for="content">내용</label>
				</div>
				<textarea class="form-control" id="boardContent" name="boardContent" rows="15" style="resize: none;">${board.boardContent }</textarea>
			</div>


			<hr class="mb-4">

			<div class="text-center">
				<button type="submit" class="btn btn-primary">수정</button>
				<button type="button" class="btn btn-primary">이전으로</button>
			</div>

		</form>
	</div>

	<jsp:include page="../common/footer.jsp"></jsp:include>
		
		
	<script>

		// 유효성 검사 
		function updateValidate() {
			if ($("#boardTitle").val().trim().length == 0) {
				alert("제목을 입력해 주세요.");
				$("#boardTitle").focus();
				return false;
			}

			if ($("#boardContent").val().trim().length == 0) {
				alert("내용을 입력해 주세요.");
				$("#boardContent").focus();
				return false;
			}
		}
		
		 // 이미지 영역을 클릭할 때 파일 첨부 창이 뜨도록 설정하는 함수
	    $(function () {
	       $("#fileArea").hide();
	
	      $(".boardImg").on("click",function(){
	        var index = $(".boardImg").index(this);
	        $("#img" + index).click();
	      });
	    });
			 

	    // 각각의 영역에 파일을 첨부 했을 경우 미리 보기가 가능하도록 하는 함수
	    function LoadImg(value, num) {
	      if (value.files && value.files[0]) {
	        var reader = new FileReader();
	        // 자바스크립트 FileReader
	       	// 웹 애플리케이션이 비동기적으로 데이터를 읽기 위하여 읽을 파일을 가리키는 File 혹은 Blob객체를 이용해 파일의 내용을 읽고 사용자의 컴퓨터에 저장하는 것을 가능하게 해주는 객체
					
	        reader.readAsDataURL(value.files[0]);
	        // FileReader.readAsDataURL()
	      	// 지정된의 내용을 읽기 시작합니다. Blob완료되면 result속성 data:에 파일 데이터를 나타내는 URL이 포함 됩니다.
	      	
	       	// FileReader.onload
					// load 이벤트의 핸들러. 이 이벤트는 읽기 동작이 성공적으로 완료 되었을 때마다 발생합니다.
	        reader.onload = function (e) {
	        	//console.log(e.target.result);
	        	// e.target.result
	        	// -> 파일 읽기 동작을 성공한 객체에(fileTag) 올라간 결과(이미지 또는 파일)
	        	
	          $(".boardImg").eq(num).children("img").attr("src", e.target.result);
	        }
	      }
	    }
    
		// 카테고리 초기값 지정
		(function(){
			$("#categoryCode > option").each(function(index, item){
				
				// 첫 번째 요소인 운동
				if( $(item).text() == "${board.categoryName}" ){
					// 			     속성 추가
					$(item).prop("selected", true);
				}
				
			});
			
		})();
		
		// 이미지 배치
		<c:forEach var="file" items="${fList}">
			$(".boardImg").eq( ${file.fileLevel} ).children("img")
				.attr("src", "${contextPath}/resources/uploadImages/${file.fileName}");
		
		</c:forEach>
		
		$("#del1").on("click", function(){
			
			$(this).prev().children("img").remove();
			
			var img = $("<img>").css("width", "200px").css("height", "200px");
			
			$(this).prev().append(img);
		});
	</script>
	
</body>
</html>
```
